{% load static %}
<div class="container mx-auto mt-8 p-4">
    {% if user.is_authenticated %}
    <div class="md:hidden mb-4 relative">
        <div class="relative flex items-center">
            <input type="text" id="mobile-search-input-home" placeholder="T√¨m ki·∫øm..." class="w-full p-2 pl-10 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 bg-[rgba(234,238,245,1)] text-black dark:bg-gray-800 dark:text-white">
            <div class="absolute left-3">
                <i class="fas fa-search text-gray-400"></i>
            </div>
        </div>
        <div id="mobile-search-results-home" class="absolute top-full text-black left-0 w-full bg-white dark:bg-gray-900 border dark:border-gray-700 border-gray-300 rounded-md mt-1 z-10 hidden shadow-lg">
        </div>
    </div>
    {% endif %}
    
    {% if user.is_superuser %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-300">{{ document_count }}</h2>
            <p class="text-gray-600 dark:text-gray-400">T√†i li·ªáu</p>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-300">{{ user_count }}</h2>
            <p class="text-gray-600 dark:text-gray-400">Ng∆∞·ªùi d√πng</p>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-300">{{ manager_count }}</h2>
            <p class="text-gray-600 dark:text-gray-400">Qu·∫£n l√Ω</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl">
            <h3 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200">üë• Danh S√°ch Ng∆∞·ªùi D√πng theo Ph√≤ng Ban</h3>
            <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                {% for data in department_data %}
                    <div class="border-b dark:border-gray-700 pb-2">
                        <p class="text-lg font-bold text-blue-600 dark:text-blue-400">{{ data.name }}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 break-words">
                            {{ data.users|join:", " }}
                        </p>
                    </div>
                {% empty %}
                    <p class="text-gray-500 dark:text-gray-400">Kh√¥ng t√¨m th·∫•y ph√≤ng ban ho·∫∑c ng∆∞·ªùi d√πng.</p>
                {% endfor %}
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl">
            <h3 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200">üìà T√†i Li·ªáu ƒê√£ T·∫£i L√™n c·ªßa Ng∆∞·ªùi D√πng</h3>
            <div class="overflow-x-auto max-h-96">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">T√™n ng∆∞·ªùi d√πng</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">S·ªë t√†i li·ªáu</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        {% for item in user_document_counts %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-200">{{ item.username }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 font-bold">
                                    <span class="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium 
                                        {% if item.doc_count > 0 %} bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300
                                        {% else %} bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300
                                        {% endif %}">
                                        {{ item.doc_count }}
                                    </span>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="2" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o (ngo·∫°i tr·ª´ Superuser).</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="document-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        {% if not user.is_authenticated %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300">
            <img src="{% static 'images/no_login.png' %}" alt="Login Required" class="w-30 h-30 object-cover">
            <div class="p-4">
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-300 mb-2">H√£y <a href="{% url 'login' %}" class="text-blue-500 hover:underline">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ xem t√†i li·ªáu.</h3>
            </div>
        </div>
        <div class="bg-[rgba(10,35,71,1)] rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300">
            <img src="{% static 'images/no_register.png' %}" alt="Login Required" class="w-30 h-30 object-cover">
            <div class="p-4">
                <h3 class="text-lg text-white font-bold mb-2">H√£y <a href="{% url 'register' %}" class="text-blue-500 hover:underline">ƒëƒÉng k√Ω</a> n·∫øu ch∆∞a c√≥ t√†i kho·∫£n</h3>
            </div>
        </div>
        {% elif not user.profile.department and not user.is_superuser %}
        <div class="col-span-full text-center text-gray-500 dark:text-gray-400">
            <p>H·ªì s∆° c·ªßa b·∫°n ch∆∞a c√≥ ph√≤ng ban. Vui l√≤ng li√™n h·ªá v·ªõi qu·∫£n tr·ªã vi√™n c·ªßa b·∫°n ƒë·ªÉ ƒë∆∞·ª£c th√™m v√†o m·ªôt ph√≤ng ban.</p>
        </div>
        {% else %}
            {% for document in documents %}
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300">
                    <img src="{{ document.image.url }}" alt="Document Image" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-300 mb-2">{{ document.title }}</h3>
                        {% if document.author %}
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
                            T√°c gi·∫£: <a href="{% url 'author-detail' document.author.id %}" class="text-blue-500 hover:underline">{{ document.author.name }}</a>
                        </p>
                        {% endif %}
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">{{ document.description }}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1"><i>ƒê∆∞·ª£c th√™m b·ªüi: {{ document.user.username }}</i></p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-1"><i>ƒê∆∞·ª£c t·∫£i l√™n l√∫c: {{ document.created_at|date:"d/m/Y H:i" }}</i></p>
                        <div class="flex justify-between items-center mt-3">
                            <div class="space-x-2">
                                <a href="{% url 'document-detail' document.id %}" class="text-white bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded-md text-sm transition duration-300">Xem chi ti·∫øt</a>
                                <a href="{{ document.document.url }}" download class="text-gray-700 bg-gray-200 hover:bg-gray-300 dark:text-white dark:bg-gray-700 dark:hover:bg-gray-600 px-3 py-1 rounded-md text-sm transition duration-300">T·∫£i xu·ªëng</a>
                            </div>
                            <form action="{% url 'toggle-favorite' document.id %}" method="POST">
                                {% csrf_token %}
                                <button type="submit" class="text-gray-400 hover:text-red-500 transition duration-300">
                                    {% if request.user in document.favorited_by.all %}
                                        <i class="fas fa-heart text-red-500 text-xl"></i>
                                    {% else %}
                                        <i class="far fa-heart text-xl"></i>
                                    {% endif %}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            {% empty %}
                {% if not user.is_superuser %}
                    <div class="col-span-full text-center text-gray-500 dark:text-gray-400">
                        <p>C√¥ng ty ch∆∞a c√≥ t√†i li·ªáu n√†o.</p>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>

    {% if user.is_authenticated and documents.has_other_pages %}
    <div class="mt-8">
        <nav class="flex justify-center">
            <ul class="flex items-center -space-x-px h-10 text-base">
                {% if documents.has_previous %}
                    <li>
                        <a href="?page={{ documents.previous_page_number }}" class="flex items-center justify-center px-4 h-10 ms-0 leading-tight text-gray-500 bg-white border border-e-0 border-gray-300 rounded-s-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
                            <span class="sr-only">Previous</span>
                            <svg class="w-3 h-3 rtl:rotate-180" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 1 1 5l4 4"/>
                            </svg>
                        </a>
                    </li>
                {% endif %}
                
                {% for i in documents.paginator.page_range %}
                    {% if documents.number == i %}
                        <li>
                            <a href="#" aria-current="page" class="z-10 flex items-center justify-center px-4 h-10 leading-tight text-blue-600 border border-blue-300 bg-blue-50 hover:bg-blue-100 hover:text-blue-700 dark:border-gray-700 dark:bg-gray-700 dark:text-white">{{ i }}</a>
                        </li>
                    {% else %}
                        <li>
                            <a href="?page={{ i }}" class="flex items-center justify-center px-4 h-10 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">{{ i }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if documents.has_next %}
                    <li>
                        <a href="?page={{ documents.next_page_number }}" class="flex items-center justify-center px-4 h-10 leading-tight text-gray-500 bg-white border border-gray-300 rounded-e-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
                            <span class="sr-only">Next</span>
                            <svg class="w-3 h-3 rtl:rotate-180" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                            </svg>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const mobileSearchInputHome = document.getElementById('mobile-search-input-home');
    const mobileSearchResultsHome = document.getElementById('mobile-search-results-home');

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function setupSearch(input, resultsContainer) {
        if (!input) return;

        const debouncedSearch = debounce(function(query) {
            if (query.length > 0) {
                // Gi·∫£ ƒë·ªãnh URL 'search' tr·∫£ v·ªÅ JSON c·ªßa c√°c t√†i li·ªáu
                fetch(`{% url 'search' %}?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        resultsContainer.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(doc => {
                                const resultItem = document.createElement('a');
                                // ƒê·∫£m b·∫£o URL chi ti·∫øt t√†i li·ªáu l√† ƒë√∫ng
                                resultItem.href = `/document/${doc.id}/`; 
                                resultItem.className = 'block p-2 text-black dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 border-b dark:border-gray-600';
                                resultItem.textContent = doc.title;
                                resultsContainer.appendChild(resultItem);
                            });
                            resultsContainer.classList.remove('hidden');
                        } else {
                            const noResultItem = document.createElement('div');
                            noResultItem.className = 'p-2 text-gray-500 dark:text-gray-300';
                            noResultItem.textContent = 'Kh√¥ng t√¨m th·∫•y t√†i li·ªáu';
                            resultsContainer.appendChild(noResultItem);
                            resultsContainer.classList.remove('hidden');
                        }
                    });
            } else {
                resultsContainer.classList.add('hidden');
            }
        }, 300);

        input.addEventListener('keyup', function() {
            debouncedSearch(input.value);
        });

        // ƒê√≥ng k·∫øt qu·∫£ t√¨m ki·∫øm khi click ra ngo√†i
        document.addEventListener('click', function(event) {
            if (resultsContainer && !input.contains(event.target) && !resultsContainer.contains(event.target)) {
                resultsContainer.classList.add('hidden');
            }
        });
    }

    setupSearch(mobileSearchInputHome, mobileSearchResultsHome);
});
</script>